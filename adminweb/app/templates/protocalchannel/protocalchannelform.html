<!-- SAMPLE BOX CONFIGURATION MODAL FORM-->
<div class="tab-pane fade" id="custom-tabs-one-detail" role="tabpanel" aria-labelledby="custom-tabs-one-detail-tab">
	<form id="form_id" role="form" action="/protocalchannel/save" method="post">
		<input type="hidden" name="record_id" value="{{selectdata.id}}">
                    <div class="row">
                        <div class="col-sm-3">
                          <!-- text input -->
                          <div class="form-group">
                            <label>通道名称</label>
                            <input type="text" class="form-control" name="device_name"  value="{{selectdata.channel_name}}" placeholder="Enter ...">
                          </div>
                        </div>
                        <div class="col-sm-3">
                          <div class="form-group">
                            <label>协议类型</label>
                               <select class="form-control" name="protocal_id" >
                                   {% for p in protocals %}
                                     {% if p.id==selectdata.protocal.id%}
                                        <option value="{{p.id}}"  selected="selected">{{selectdata.protocal.protocal_name}}--{{selectdata.protocal.protocal_type}}</option>
                                       {% else%}
                                        <option value="{{p.id}}"  >{{p.protocal_name}}--{{p.protocal_type}}</option>
                                     {% endif%}
                                   {% endfor %}

                        </select>
                            <!--<input type="text" class="form-control" name="device_no" value="{{selectdata.protocal.protocal_name}}/{{selectdata.protocal.protocal_type}}" placeholder="Enter ..." >-->
                          </div>
                        </div>

                        <div class="col-sm-3">
                          <!-- text input -->
                          <div class="form-group">
                            <label>IP地址/串口编号</label>
                            <input type="text" class="form-control" name="server_ip"  value="{{selectdata.ipaddress}}" placeholder="Enter ...">
                          </div>
                        </div>
                        <div class="col-sm-3">
                          <div class="form-group">
                            <label>端口号</label>
                            <input type="text" class="form-control" name="protocal_port" value="{{selectdata.port}}" placeholder="Enter ..." >
                          </div>
                        </div>
                     </div>

                <div class="row">

                    <div class="col-sm-3">
                        <div class="form-group">
                              <label class="col-form-label" for="timeout"> 超时设置</label>
                              <input type="text" class="form-control" id="timeout" value="{{selectdata.time_out}}" name="timeout" placeholder="Enter ...">
                         </div>
                    </div>
                     <div class="col-sm-3">
                        <div class="form-group">
                              <label class="col-form-label" for="refreshtime">刷新时间</label>
                              <input type="text" class="form-control" id="refreshtime" value="{{selectdata.refreshtime}}" name="refreshtime" placeholder="Enter ...">
                         </div>
                    </div>
                    <div class="col-sm-3">
                        <div class="form-group">
                              <label class="col-form-label" for="comment"> 备注信息</label>
                              <input type="text" class="form-control" id="comment" value="{{selectdata.comment}}" name="comment" placeholder="Enter ...">
                         </div>
                    </div>
                    <div class="col-sm-3">

                            <div class="custom-control custom-checkbox">
                                {%if selectdata.isactive=='Y' %}
                                <input class="custom-control-input" checked type="checkbox" name="isactive" id="isactive" value="Y">
                                {% else %}
                                <input class="custom-control-input"  type="checkbox" name="isactive" id="isactive" value="N">
                                {% endif %}
                                <label for="isactive" class="custom-control-label">是否有效</label>
                            </div>

                     </div>

                </div>
                        <!-- /.card-body -->

                        <div class="card-footer">
                          <button type="button" onclick="saveOneRecord();" class="btn btn-primary">保存</button>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                             <button type="button" onclick="javascript:CheckConnected({{selectdata.id}});" class="btn btn-info">测试连接</button>

                          <button type="button" onclick="javascript:cancel();" class="btn btn-info float-right">取消/返回</button>
                        </div>

    </form>

<div class="card-header p-0 pt-1">
    <h4>设备信息</h4>
</div>

<div class="row">
    <div class="col-sm-12">
              <div class="tab-content" id="custom-tabs-one-tabContent">
                <div class="tab-pane fade show active" id="custom-tabs-one-home" role="tabpanel" aria-labelledby="custom-tabs-one-home-tab">
                  <table id="datalist" class="table align-middle table-bordered table-hover">
                    <thead>
                    <tr>
                          <th>设备名称</th>
                          <th>设备编号</th>
                          <th>功能码</th>
                        <th>单元号</th>
                          <th>开始地址</th>
                          <th>读取数量</th>
                        <th>是否有效</th>
                          <th>备注</th>
                          <th class="hidden-xs ">操作</th>
                      </tr>
                    </thead>
                    <tbody>
                    {% for data in channel_units %}
                      <tr>
                        <td>{{data.device_name}}</td>
						<td>{{data.deviceno}}</td>
                        <td>{{data.function_code}}</td>
                          <td>{{data.unit_id}}</td>
                        <td> {{data.startfrom}}</td>
                        <td>{{data.quantity}}</td>
                           <td>{{data.isactive}}</td>
                        <td>{{data.comment}}</td>
                        <td class="text-center py-0 align-middle">
                          <div class="btn-group btn-group-sm">
                            <a href="#" class="btn btn-info" onclick="javascript:ReadData({{selectdata.id}},{{data.unit_id}},'{{data.function_code}}',{{data.startfrom}},{{data.quantity}})"><i class="fas fa-edit"></i></a>
                            &nbsp;&nbsp;

                          </div>
                        </td>
                      </tr>
                    {% endfor %}
                    </tbody>
                  </table>
                </div>

              </div>
            </div>
</div>
</div>
</div>


<script>
$(function() {
    $('#pickdate1').daterangepicker({  
      showDropdowns: true,
     showWeekNumbers: false,
     timePicker: false,
     timePickerIncrement: 2,
     singleDatePicker: true,
     timePicker24Hour: true,
        autoUpdateInput: false, //必须设置为false,否则会自动填充，把原有的数据冲掉，然后再修改源代码，在合适的地方设为true
     startDate: moment(),//moment().add(1,'days')表示今天的基础上加一天
        locale: {
	    	    	format: "YYYY-MM-DD",
	    	    	separator: " - ",
	    	    	daysOfWeek: ["日","一","二","三","四","五","六"],
	    	    	monthNames: ["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"]
	    	   }
          
      })

      //launch save message for user
    toastr.options = {
        closeButton: false,
        debug: false,
        positionClass: "toast-top-right ",
        onclick: null,
        showDuration: "300",
        hideDuration: "1000",
        timeOut: "1500",
        extendedTimeOut: "1000",
        showEasing: "swing",
        hideEasing: "linear",
        showMethod: "fadeIn",
        hideMethod: "fadeOut"
    };

    {% for msg in get_flashed_messages(category_filter=['save_info'])  %}
      toastr.success('{{msg}}');
    {% endfor %}


});



//save one record
  function saveOneRecord()
  {
        if ($('#isactive').is(':checked'))
        {
            $('#isactive').val('Y');
        }
        else
        {
            $('#isactive').val('N');
        }
		$.ajax({
			url: '/protocalchannel/save',
			type: 'POST',
			cache:false,
			dataType: 'html',
			data: $('#form_id').serialize(),
			success: function (response) {
				var result = $('#custom-tabs-one-detail').append(response).find('#custom-tabs-one-detail').html();
				$('#custom-tabs-one-detail').html(result);
				$("#custom-tabs-one-detail-tab").click();
			},
			error:function(response){
			  alert('save error');
			}
		});
  }
function CheckConnected(id)
{
    $.ajax({
			url: '/get/status'+'/'+id,
			type: 'GET',
			cache:false,
			dataType: 'html',
			success: function (response) {
			    alert(response);
			},
			error:function(response){
			  alert('check error');
			}
		});
}
function ReadData(channel_id,unit_id,code,start,quantity)
{
   if (code == 'READ_HOLDING_REGISTERS' || code == '03'){
      code = 3
   }else if(code == 'READ_DISCRETE_INPUTS' || code == '02'){
      code = 2
   }else if(code == 'READ_COILS' || code == '01'){
      code = 1
   }else if(code == 'READ_INPUT_REGISTERS' || code == '04'){
      code = 4
   }

    $.ajax({
			url: '/get/modbus'+'/'+channel_id+'/'+unit_id+','+code+','+start+','+quantity,
			type: 'GET',
			cache:false,
			dataType: 'html',
			success: function (response) {
			    alert(response);
			},
			error:function(response){
			  alert('read error');
			}
		});
}
  function cancel(){
    $.ajax({
			url: '/protocalchannel/list',
			type: 'GET',
			cache:false,
			dataType: 'html',
			success: function (response) {
			    var result = $('#custom-tabs-one-home').append(response).find('#custom-tabs-one-home').html();
				$('#custom-tabs-one-home').html(result);
				$('#custom-tabs-one-home-tab').click();
			}
		});

  }
</script>

