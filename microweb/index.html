<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>智能网关配置</title>
    <link rel="stylesheet" href="jquery-ui.css">
<style>
  .ui-progressbar {
    position: relative;
  }
  .progress-label {
    position: absolute;
    left: 30%;
    top: 2px;
    font-weight: bold;
    text-shadow: 1px 1px 0 #fff;
  }
  </style>
  <script>


  </script>
</head>

    <body>

<div id="accordion">
  <h3>基本信息</h3>
  <div>
    <p>
    <h4>当前设备编号：<label id="message"></label></h4>
    </p>
      <input type="text" id="ssid" name="ssid"  placeholder="输入WiFI的SSID">
    <br/>
      <input type="text" id="wifipassword" name="wifipassword"  placeholder="输入WiFI密码">
    <br/>
      <input type="button" value="测试" onclick="operate_wifi('connect')"> &nbsp;&nbsp;&nbsp;&nbsp;
      <input type="button" onclick="operate_wifi('save')" value="保存">

    <p>
      <div id="progressbar">
          <div class="progress-label">.</div>
     </div>
    </p>
  </div>
  <h3>MODBUS RTU配置</h3>
  <div >
    <p>

              <label for="baundrate">波特率:</label>
        <input align="left"  type="text" id="baundrate" name="baundrate"  placeholder="默认115200">

       </p>

      <div id="toolbar" class="ui-widget-header ui-corner-all">
          <input type="checkbox"  id="shuffle"><label for="shuffle">数据位：8</label>
           <input type="checkbox" id="shuffle2"><label for="shuffle2">停止位：1</label>
          <input type="checkbox" id="shuffle3"><label for="shuffle3">校验：无</label>
          <br>
           <input align="center"  type="text" id="device_rtu_no" name="device_rtu_no"  placeholder="设备编号">
          <input  type="text" id="rtu_slaveaddr" name="rtu_slaveaddr"  placeholder="从站地址(ID)">
          <input  type="text" id="rtu_startaddr" name="rtu_startaddr"  placeholder="寄存器地址">
          <input  type="text" id="rtu_readquantity" name="rtu_readquantity"  placeholder="读取数量">
      </div>

     <span id="check">


           <input type="radio" id="fr03" name="project">
          <label for="fr03">读保持寄存器(03)</label>

           <input type="radio" id="fr02" name="project">
          <label for="fr02">读离散输入(02)</label>
     </span>
     <br/>
              <input type="button" value="测试" onclick="operate_modbus_rtu('connect')"> &nbsp;&nbsp;&nbsp;&nbsp;
              <input type="button" onclick="operate_modbus_rtu('save')" value="保存"> &nbsp;&nbsp;&nbsp;&nbsp;
              <input type="button" onclick="load_modbus('rtu')" value="加载">
            <p>
              <div id="progressbar3">
                  <div align="center" class="progress-label">.</div>
             </div>
      <div id="modbusrtulist">

      </div>
            </p>
  </div>

    <h3>MODBUS TCP配置</h3>
  <div >

      <input align="center"  type="text" id="device_no" name="device_no"  placeholder="设备编号">
      <input align="left"  type="text" id="slaveip" name="slaveip"  placeholder="输入从站的ip">
               <input  type="text" id="slaveport" name="slaveport"  placeholder="端口号">
              <input  type="text" id="slaveaddr" name="slaveaddr"  placeholder="从站地址(ID)">
              <input  type="text" id="startaddr" name="startaddr"  placeholder="寄存器地址">
               <input  type="text" id="readquantity" name="readquantity"  placeholder="读取数量"> <br/>

     <span id="check2">


           <input type="radio" id="ft03"  name="project">
          <label for="ft03">功能码03</label>

           <input type="radio" id="ft02" value="ft02" name="project">
          <label for="ft02">功能码02</label>
     </span>
    <br/>
              <input type="button" value="测试" onclick="operate_modbus('connect')"> &nbsp;&nbsp;&nbsp;&nbsp;
              <input type="button" onclick="operate_modbus('save')" value="保存"> &nbsp;&nbsp;&nbsp;&nbsp;
              <input type="button" onclick="load_modbus('tcp')" value="加载">
            <p>
              <div id="progressbar2">
                  <div align="center" class="progress-label">.</div>
             </div>
      <div id="modbustcplist">

      </div>
            </p>
  </div>


  <h3>LoRa配置</h3>
  <div>
    <p>
   <label for="frequency">频率(kHz):</label>
        <input  type="text" id="frequency" name="frequency"  placeholder="默认433000">
    </p>
    <br/>
              <input type="button" value="加载" > &nbsp;&nbsp;&nbsp;&nbsp;
              <input type="button" onclick="operate_lora('save')" value="保存">
            <p>
              <div id="progressbar4">
                  <div align="center" class="progress-label">.</div>
             </div>
            </p>
  </div>
  <h3>MQTT配置</h3>
  <div>
    <p>
   <input align="left"  type="text" id="mqttip" name="mqttip"  placeholder="MQTT服务器的ip">
               <input  type="text" id="mqttport" name="mqttport"  placeholder="端口号">
              <input  type="text" id="mqtttopic" name="mqtttopic"  placeholder="主题/topic/">
              <input  type="text" id="mqttuser" name="mqttuser"  placeholder="用户名">
               <input  type="text" id="mqttpassword" name="mqttpassword"  placeholder="密码">
    </p>
      <br/>
              <input type="button" value="测试" > &nbsp;&nbsp;&nbsp;&nbsp;
              <input type="button" onclick="operate_mqtt('save')" value="保存">
            <p>
              <div id="progressbar5">
                  <div align="center" class="progress-label">.</div>
             </div>
            </p>

  </div>
</div>
    <script src="jquery-3.5.1.min.js"></script>
    <script src="jquery-ui.min.js"></script>
<script>

$(function(){
    $( "#accordion" ).accordion();
    $( "button, input, a" ).button();
    $( "select" ).selectmenu();
    $( "#check" ).buttonset();
    $( "#check2" ).buttonset();
    $( "#shuffle" ).button();
    $( "#shuffle2" ).button();
    $( "#shuffle3" ).button();

    //$("#ft02").attr("checked","checked");
    onLoad();

   });

function getCookie(name) {
        var value = "; " + document.cookie;
        //alert(value);
        var parts = value.split("; " + name + "=");
        //alert(parts);
        if (parts.length == 2)
            //alert(parts.pop().split(";").shift());
            return parts.pop().split(";").shift();
        }
function showMessage() {
       //alert(getCookie('user_cookies')+' ssid,'+getCookie('ssid_c')+'-lora-'+getCookie('baundrate'));
       document.getElementById('message').innerHTML = getCookie('machine_cookies');
       $("#ssid").val(getCookie('ssid_c'));
       $("#wifipassword").val(getCookie('wifi_c'));
       $("#frequency").val(getCookie('frequency'));
       $("#baundrate").val(getCookie('baundrate'));
       //$("#baundrate option[value='57600']").attr("selected","selected");
       $("#mqttip").val(getCookie('mqttip'));
       $("#mqttport").val(getCookie('mqttport'));
       $("#mqtttopic").val(getCookie('mqtttopic'));
       $("#mqttuser").val(getCookie('mqttuser'));
       $("#mqttpassword").val(getCookie('mqttpassword'));


}
function onLoad() {
       showMessage();
}


 function operate_wifi(p)
{
  var progressbar = $( "#progressbar" ),
      progressLabel = $( ".progress-label" );
      $( "#progressbar" ).progressbar({
      value: false
    });
    progressLabel.text("处理中.......");

    var ssid=$('#ssid').val();
    var wifipassword=$('#wifipassword').val();
    var json_data = JSON.stringify({
             'ssid': ssid,
             'wifipassword': wifipassword
           });

     alert(json_data);

     if (p == 'connect')
     {
         $.ajax({
               type:"post",//请求方式
               url:"/post/connect/wifi",//发送请求地址
               timeout:20000,//超时时间：20秒
               data:json_data,
               dataType:"html",//设置返回数据的格式
               //请求成功后的回调函数 data为html格式
               success:function(res){
                   alert('success'+res);
                   obj = JSON.parse(res);
                   //JSON.stringify(); //JavaScript 值转换为 JSON 字符串
                   if (obj['connected']=='True')
                   {
                        progressbar.progressbar({
                             value: true,
                        });
                      progressLabel.text("连接成功,请保存！");
                   }
                   else
                   {
                     progressbar.progressbar({
                             value: true,
                        });
                      progressLabel.text("连接失败,重试一下吧！");
                   }

              },
              //请求出错的处理
              error:function(){
                 progressbar.progressbar({
                             value: true,
                        });
                 progressLabel.text("出错了，请重试....！");;
              }
           });
     }

     if (p == 'save')
     {
         $.ajax({
               type:"post",//请求方式
               url:"/post/save/wifi",//发送请求地址
               timeout:20000,//超时时间：20秒
               data:json_data,
               dataType:"html",//设置返回数据的格式
               //请求成功后的回调函数 data为html格式
               success:function(res){
                   alert('success'+res);
                   obj = JSON.parse(res);
                   //JSON.stringify(); //JavaScript 值转换为 JSON 字符串
                   if (obj['connected']=='True')
                   {
                        progressbar.progressbar({
                             value: true,
                        });
                      progressLabel.text("保存成功！");
                   }
                   else
                   {
                     progressbar.progressbar({
                             value: true,
                        });
                      progressLabel.text("保存失败,重试一下吧！");
                   }

              },
              //请求出错的处理
              error:function(){
                 progressbar.progressbar({
                             value: true,
                        });
                 progressLabel.text("出错了，请重试....！");;
              }
           });
     }

}

function operate_modbus(p)
{
  var progressbar = $( "#progressbar2" ),
      progressLabel = $( ".progress-label" );
      $( "#progressbar2" ).progressbar({
      value: false
    });

    progressLabel.text("处理中.......");

    alert($('#ft03').is(':checked'));

    //alert($("#ft03").get(0).checked);


    var json_data = JSON.stringify({
             'device_no': $('#device_no').val(),
             'slaveip': $('#slaveip').val(),
             'slaveport': $('#slaveport').val(),
             'slaveaddr': $('#slaveaddr').val(),
             'startaddr': $('#startaddr').val(),
             'readquantity': $('#readquantity').val(),
             'ft03': $('#ft03').is(':checked'),
             'ft02': $('#ft02').is(':checked')
           });

     alert(json_data);

     if (p == 'connect')
     {
         $.ajax({
               type:"post",//请求方式
               url:"/post/connect/modbus",//发送请求地址
               timeout:5000,//超时时间：5秒
               data:json_data,
               dataType:"html",//设置返回数据的格式
               //请求成功后的回调函数 data为html格式
               success:function(res){
                   alert('success'+res);
                   obj = JSON.parse(res);
                   //JSON.stringify(); //JavaScript 值转换为 JSON 字符串
                   if (obj['connected']=='True')
                   {
                        progressbar.progressbar({
                             value: true,
                        });
                      progressLabel.text("成功:"+obj['data']);
                   }
                   else
                   {
                     progressbar.progressbar({
                             value: true,
                        });
                      progressLabel.text("读取失败,重试一下吧！");
                   }

              },
              //请求出错的处理
              error:function(){
                 progressbar.progressbar({
                             value: true,
                        });
                 progressLabel.text("出错了，请重试....！");
              }
           });
     }

     if (p == 'save')
     {
         $.ajax({
               type:"post",//请求方式
               url:"/post/save/modbus",//发送请求地址
               timeout:20000,//超时时间：20秒
               data:json_data,
               dataType:"html",//设置返回数据的格式
               //请求成功后的回调函数 data为html格式
               success:function(res){
                   alert('success'+res);
                   obj = JSON.parse(res);
                   //JSON.stringify(); //JavaScript 值转换为 JSON 字符串
                   if (obj['connected']=='True')
                   {
                        progressbar.progressbar({
                             value: true,
                        });
                      progressLabel.text("保存成功！");
                      load_modbus('tcp');
                   }
                   else
                   {
                     progressbar.progressbar({
                             value: true,
                        });
                      progressLabel.text("保存失败,重试一下吧！");
                   }

              },
              //请求出错的处理
              error:function(){
                 progressbar.progressbar({
                             value: true,
                        });
                 progressLabel.text("出错了，请重试....！");
              }
           });
     }


}
function load_modbus(p)
{
      if (p == 'tcp')
     {
        $("#modbustcplist").empty();
        $("#progressbar2").css("display","none");
         $.ajax({
               type:"get",//请求方式
               url:"/get/load/modbus",//发送请求地址
               timeout:20000,//超时时间：20秒
               dataType:"json",//设置返回数据的格式
               //请求成功后的回调函数 data为html格式
               success:function(res){
                   var str = "<ul>";
                   $.each(res.data, function(idx,val) {
                    str +="<li>"+val.device+","+val.ip+","+val.port+","+"id:"+val.slave_id+","+val.function+","+val.address+","+val.quantity+ "&nbsp;&nbsp;"+"<input type='button' onclick='delete_modbus("+idx+")' value='删除' >"+"</li>";
                  });
                  str += "</ul>";
                  $('#modbustcplist').append(str);

              },
              //请求出错的处理
              error:function(){
                 var str = "出错了，请重试....！";
                $('#modbustcplist').append(str);
              }
           });
     }

     if (p == 'rtu')
     {
        $("#modbusrtulist").empty();
        $("#progressbar3").css("display","none");
         $.ajax({
               type:"get",//请求方式
               url:"/get/load/modbus_rtu",//发送请求地址
               timeout:20000,//超时时间：20秒
               dataType:"json",//设置返回数据的格式
               //请求成功后的回调函数 data为html格式
               success:function(res){
                   var str = "<ul>";
                   $.each(res.data, function(idx,val) {
                    str +="<li>"+val.device+","+"id:"+val.slave_id+","+val.function+","+val.address+","+val.quantity+ "&nbsp;&nbsp;"+"<input type='button' onclick='delete_modbus_rtu("+idx+")' value='删除' >"+"</li>";
                  });
                  str += "</ul>";
                  $('#modbusrtulist').append(str);

              },
              //请求出错的处理
              error:function(){
                 var str = "出错了，请重试....！";
                $('#modbusrtulist').append(str);
              }
           });
     }
}
function delete_modbus(id)
{
    var json_data = JSON.stringify({
             'id': id
           });

    $.ajax({
               type:"post",//请求方式
               url:"/post/delete/modbus",//发送请求地址
               timeout:20000,//超时时间：20秒
               data: json_data,
               dataType:"html",//设置返回数据的格式
               //请求成功后的回调函数 data为html格式
               success:function(res){
                   load_modbus('tcp');

              },
              //请求出错的处理
              error:function(){
                 var str = "出错了，请重试....！";
                $('#modbustcplist').append(str);
              }
           });
}

function delete_modbus_rtu(id)
{
    var json_data = JSON.stringify({
             'id': id
           });

    $.ajax({
               type:"post",//请求方式
               url:"/post/delete/modbus_rtu",//发送请求地址
               timeout:20000,//超时时间：20秒
               data: json_data,
               dataType:"html",//设置返回数据的格式
               //请求成功后的回调函数 data为html格式
               success:function(res){
                   load_modbus('rtu');

              },
              //请求出错的处理
              error:function(){
                 var str = "出错了，请重试....！";
                $('#modbusrtulist').append(str);
              }
           });
}

function operate_modbus_rtu(p)
{
  var progressbar = $( "#progressbar3" ),
      progressLabel = $( ".progress-label" );
      $( "#progressbar3" ).progressbar({
      value: false
    });
    progressLabel.text("处理中.......");

    //alert($("#ft03").get(0).checked);


    var json_data = JSON.stringify({
             'baundrate': $('#baundrate').val(),
             'device_rtu_no': $('#device_rtu_no').val(),
             'rtu_slaveaddr': $('#rtu_slaveaddr').val(),
             'rtu_startaddr': $('#rtu_startaddr').val(),
             'rtu_readquantity': $('#rtu_readquantity').val(),
             'fr03': $('#fr03').is(':checked'),
             'fr02': $('#fr02').is(':checked')
           });

     alert(json_data);

     if (p == 'connect')
     {
         $.ajax({
               type:"post",//请求方式
               url:"/post/connect/modbus_rtu",//发送请求地址
               timeout:5000,//超时时间：5秒
               data:json_data,
               dataType:"html",//设置返回数据的格式
               //请求成功后的回调函数 data为html格式
               success:function(res){
                   alert('success'+res);
                   obj = JSON.parse(res);
                   //JSON.stringify(); //JavaScript 值转换为 JSON 字符串
                   if (obj['connected']=='True')
                   {
                        progressbar.progressbar({
                             value: true,
                        });
                      progressLabel.text("成功:"+obj['data']);
                   }
                   else
                   {
                     progressbar.progressbar({
                             value: true,
                        });
                      progressLabel.text("读取失败,重试一下吧！");
                   }

              },
              //请求出错的处理
              error:function(){
                 progressbar.progressbar({
                             value: true,
                        });
                 progressLabel.text("出错了，请重试....！");
              }
           });
     }

     if (p == 'save')
     {
         $.ajax({
               type:"post",//请求方式
               url:"/post/save/modbus_rtu",//发送请求地址
               timeout:20000,//超时时间：20秒
               data:json_data,
               dataType:"html",//设置返回数据的格式
               //请求成功后的回调函数 data为html格式
               success:function(res){
                   alert('success'+res);
                   obj = JSON.parse(res);
                   //JSON.stringify(); //JavaScript 值转换为 JSON 字符串
                   if (obj['connected']=='True')
                   {
                        progressbar.progressbar({
                             value: true,
                        });
                      progressLabel.text("保存成功！");
                      load_modbus('rtu');
                   }
                   else
                   {
                     progressbar.progressbar({
                             value: true,
                        });
                      progressLabel.text("保存失败,重试一下吧！");
                   }

              },
              //请求出错的处理
              error:function(){
                 progressbar.progressbar({
                             value: true,
                        });
                 progressLabel.text("出错了，请重试....！");;
              }
           });
     }

}

function operate_lora(p)
{
   var progressbar = $( "#progressbar4" ),
      progressLabel = $( ".progress-label" );
      $( "#progressbar4" ).progressbar({
      value: false
    });
    progressLabel.text("处理中.......");

    var json_data = JSON.stringify({
             'frequency': $('#frequency').val()
           });

     alert(json_data);

     if (p == 'load')
     {
         $.ajax({
               type:"post",//请求方式
               url:"/post/load/lora",//发送请求地址
               timeout:5000,//超时时间：5秒
               data:json_data,
               dataType:"html",//设置返回数据的格式
               //请求成功后的回调函数 data为html格式
               success:function(res){
                   alert('success'+res);
                   obj = JSON.parse(res);
                   //JSON.stringify(); //JavaScript 值转换为 JSON 字符串
                   if (obj['connected']=='True')
                   {
                        progressbar.progressbar({
                             value: true,
                        });
                      progressLabel.text("成功:"+obj['data']);
                   }
                   else
                   {
                     progressbar.progressbar({
                             value: true,
                        });
                      progressLabel.text("读取失败,重试一下吧！");
                   }

              },
              //请求出错的处理
              error:function(){
                 progressbar.progressbar({
                             value: true,
                        });
                 progressLabel.text("出错了，请重试....！");
              }
           });
     }

     if (p == 'save')
     {
         $.ajax({
               type:"post",//请求方式
               url:"/post/save/lora",//发送请求地址
               timeout:20000,//超时时间：20秒
               data:json_data,
               dataType:"html",//设置返回数据的格式
               //请求成功后的回调函数 data为html格式
               success:function(res){
                   alert('success'+res);
                   obj = JSON.parse(res);
                   //JSON.stringify(); //JavaScript 值转换为 JSON 字符串
                   if (obj['connected']=='True')
                   {
                        progressbar.progressbar({
                             value: true,
                        });
                      progressLabel.text("保存成功！");
                   }
                   else
                   {
                     progressbar.progressbar({
                             value: true,
                        });
                      progressLabel.text("保存失败,重试一下吧！");
                   }

              },
              //请求出错的处理
              error:function(){
                 progressbar.progressbar({
                             value: true,
                        });
                 progressLabel.text("出错了，请重试....！");
              }
           });
     }

}

function operate_mqtt(p)
{
   var progressbar = $( "#progressbar5" ),
      progressLabel = $( ".progress-label" );
      $( "#progressbar5" ).progressbar({
      value: false
    });
    progressLabel.text("处理中.......");

    var json_data = JSON.stringify({
             'mqttip': $('#mqttip').val(),
             'mqttport': $('#mqttport').val(),
             'mqtttopic': $('#mqtttopic').val(),
             'mqttuser': $('#mqttuser').val(),
             'mqttpassword': $('#mqttpassword').val()
           });

     alert(json_data);

     if (p == 'load')
     {
         $.ajax({
               type:"post",//请求方式
               url:"/post/load/lora",//发送请求地址
               timeout:5000,//超时时间：5秒
               data:json_data,
               dataType:"html",//设置返回数据的格式
               //请求成功后的回调函数 data为html格式
               success:function(res){
                   alert('success'+res);
                   obj = JSON.parse(res);
                   //JSON.stringify(); //JavaScript 值转换为 JSON 字符串
                   if (obj['connected']=='True')
                   {
                        progressbar.progressbar({
                             value: true,
                        });
                      progressLabel.text("成功:"+obj['data']);
                   }
                   else
                   {
                     progressbar.progressbar({
                             value: true,
                        });
                      progressLabel.text("读取失败,重试一下吧！");
                   }

              },
              //请求出错的处理
              error:function(){
                 progressbar.progressbar({
                             value: true,
                        });
                 progressLabel.text("出错了，请重试....！");
              }
           });
     }

     if (p == 'save')
     {
         $.ajax({
               type:"post",//请求方式
               url:"/post/save/mqtt",//发送请求地址
               timeout:20000,//超时时间：20秒
               data:json_data,
               dataType:"html",//设置返回数据的格式
               //请求成功后的回调函数 data为html格式
               success:function(res){
                   alert('success'+res);
                   obj = JSON.parse(res);
                   //JSON.stringify(); //JavaScript 值转换为 JSON 字符串
                   if (obj['connected']=='True')
                   {
                        progressbar.progressbar({
                             value: true,
                        });
                      progressLabel.text("保存成功！");
                   }
                   else
                   {
                     progressbar.progressbar({
                             value: true,
                        });
                      progressLabel.text("保存失败,重试一下吧！");
                   }

              },
              //请求出错的处理
              error:function(){
                 progressbar.progressbar({
                             value: true,
                        });
                 progressLabel.text("出错了，请重试....！");
              }
           });
     }

}

</script>

</body>

</html>
